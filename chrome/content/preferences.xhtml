<div id="zotero-prefpane-aireader"
     xmlns="http://www.w3.org/1999/xhtml"
     onload="AIReaderPrefs.init()">

  <style>
    #zotero-prefpane-aireader {
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    .aireader-groupbox {
      margin-bottom: 20px;
      padding: 12px;
      border: 1px solid var(--fill-quinary, #e0e0e0);
      border-radius: 8px;
      background: var(--material-background, #fff);
    }
    .aireader-groupbox-title {
      font-size: 15px;
      font-weight: 600;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--fill-quinary, #e0e0e0);
      color: var(--fill-primary, #333);
    }
    .aireader-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .aireader-label {
      width: 100px;
      font-size: 13px;
      flex-shrink: 0;
    }
    .aireader-input {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--fill-quinary, #ccc);
      border-radius: 6px;
      font-size: 13px;
      background: var(--material-background, #fff);
      color: var(--fill-primary, #333);
    }
    .aireader-input:focus {
      outline: none;
      border-color: var(--accent-blue, #0066cc);
    }
    .aireader-select {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--fill-quinary, #ccc);
      border-radius: 6px;
      font-size: 13px;
      background: var(--material-background, #fff);
      color: var(--fill-primary, #333);
    }
    .aireader-checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .aireader-checkbox-label {
      font-size: 13px;
    }
    .aireader-button {
      padding: 8px 16px;
      border: 1px solid var(--fill-quinary, #ccc);
      border-radius: 6px;
      background: var(--material-background, #fff);
      color: var(--fill-primary, #333);
      cursor: pointer;
      font-size: 13px;
    }
    .aireader-button:hover {
      background: var(--fill-quinary, #f0f0f0);
    }
    .aireader-button-primary {
      background: var(--accent-blue, #0066cc);
      color: white;
      border-color: var(--accent-blue, #0066cc);
    }
    .aireader-result {
      font-size: 13px;
      padding: 8px;
    }
    .aireader-result.success {
      color: #28a745;
    }
    .aireader-result.error {
      color: #dc3545;
    }
    .aireader-slider-container {
      display: flex;
      align-items: center;
      flex: 1;
      gap: 8px;
    }
    .aireader-slider {
      flex: 1;
    }
    .aireader-slider-value {
      width: 40px;
      text-align: center;
      font-size: 13px;
    }
    .aireader-hidden {
      display: none !important;
    }
  </style>

  <!-- API Settings -->
  <div class="aireader-groupbox">
    <label class="aireader-groupbox-title">API 设置</label>

    <div class="aireader-row">
      <label class="aireader-label">API Key:</label>
      <input id="aireader-apiKey" type="password" class="aireader-input"
             placeholder="输入您的 API Key" />
    </div>

    <div class="aireader-row">
      <label class="aireader-label">API 端点:</label>
      <input id="aireader-apiEndpoint" type="text" class="aireader-input"
             placeholder="https://api.openai.com/v1" />
    </div>

    <div class="aireader-row">
      <label class="aireader-label">模型:</label>
      <select id="aireader-model" class="aireader-select">
        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
        <option value="gpt-4">gpt-4</option>
        <option value="gpt-4-turbo">gpt-4-turbo</option>
        <option value="gpt-4o">gpt-4o</option>
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="claude-3-5-sonnet-20241022">claude-3-5-sonnet</option>
        <option value="custom">自定义模型</option>
      </select>
    </div>

    <div id="aireader-customModel-row" class="aireader-row aireader-hidden">
      <label class="aireader-label">自定义模型:</label>
      <input id="aireader-customModel" type="text" class="aireader-input"
             placeholder="输入模型名称，如 qwen-turbo" />
    </div>

    <div class="aireader-row">
      <label class="aireader-label">温度 (0-2):</label>
      <div class="aireader-slider-container">
        <input id="aireader-temperature" type="range" class="aireader-slider"
               min="0" max="2" step="0.1" value="0.7" />
        <span id="aireader-temperature-value" class="aireader-slider-value">0.7</span>
      </div>
    </div>

    <div class="aireader-row">
      <button id="aireader-testConnection" class="aireader-button">测试连接</button>
      <span id="aireader-testResult" class="aireader-result"></span>
    </div>
  </div>

  <!-- Feature Settings -->
  <div class="aireader-groupbox">
    <label class="aireader-groupbox-title">功能设置</label>

    <div class="aireader-checkbox-row">
      <input id="aireader-enableTranslation" type="checkbox" checked="checked" />
      <label class="aireader-checkbox-label" for="aireader-enableTranslation">启用翻译功能</label>
    </div>

    <div class="aireader-checkbox-row">
      <input id="aireader-enableSummary" type="checkbox" checked="checked" />
      <label class="aireader-checkbox-label" for="aireader-enableSummary">启用摘要功能</label>
    </div>

    <div class="aireader-checkbox-row">
      <input id="aireader-enableQA" type="checkbox" checked="checked" />
      <label class="aireader-checkbox-label" for="aireader-enableQA">启用问答功能</label>
    </div>

    <div class="aireader-checkbox-row">
      <input id="aireader-enableStreaming" type="checkbox" checked="checked" />
      <label class="aireader-checkbox-label" for="aireader-enableStreaming">启用流式输出</label>
    </div>

    <div class="aireader-checkbox-row">
      <input id="aireader-autoSaveHistory" type="checkbox" />
      <label class="aireader-checkbox-label" for="aireader-autoSaveHistory">自动保存聊天历史到笔记</label>
    </div>

    <div class="aireader-row">
      <label class="aireader-label">默认语言:</label>
      <select id="aireader-defaultLanguage" class="aireader-select">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁体中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="ko">한국어</option>
        <option value="fr">Français</option>
        <option value="de">Deutsch</option>
      </select>
    </div>
  </div>

  <!-- Advanced Settings -->
  <div class="aireader-groupbox">
    <label class="aireader-groupbox-title">高级设置</label>

    <div class="aireader-row">
      <label class="aireader-label">Max Tokens:</label>
      <input id="aireader-maxTokens" type="number" class="aireader-input"
             min="100" max="32000" value="2000" style="width: 120px; flex: none;" />
      <span style="font-size: 12px; color: #666;">(100-32000)</span>
    </div>

    <div class="aireader-row">
      <label class="aireader-label">请求超时:</label>
      <input id="aireader-timeout" type="number" class="aireader-input"
             min="5" max="300" value="30" style="width: 120px; flex: none;" />
      <span style="font-size: 12px; color: #666;">秒 (5-300)</span>
    </div>

    <div class="aireader-row">
      <label class="aireader-label">历史消息数:</label>
      <input id="aireader-maxHistory" type="number" class="aireader-input"
             min="1" max="50" value="10" style="width: 120px; flex: none;" />
      <span style="font-size: 12px; color: #666;">(1-50)</span>
    </div>

    <div class="aireader-checkbox-row">
      <input id="aireader-debugMode" type="checkbox" />
      <label class="aireader-checkbox-label" for="aireader-debugMode">启用调试模式</label>
    </div>
  </div>

  <!-- About -->
  <div class="aireader-groupbox">
    <div class="aireader-row" style="justify-content: space-between;">
      <div>
        <div style="font-size: 14px; font-weight: 600;">ZoteroPatch AI Reader</div>
        <div style="font-size: 12px; color: #666;">v0.3.1</div>
      </div>
      <button id="aireader-resetDefaults" class="aireader-button">重置为默认值</button>
    </div>
  </div>

  <script><![CDATA[
    var AIReaderPrefs = {
      PREF_PREFIX: 'extensions.aireader.',

      init: function() {
        console.log('[AIReader Prefs] Initializing...');
        this.loadSettings();
        this.initEventListeners();
        console.log('[AIReader Prefs] Initialization complete');
      },

      getPref: function(key, defaultValue) {
        try {
          const value = Zotero.Prefs.get(this.PREF_PREFIX + key, true);
          return value !== undefined && value !== null ? value : defaultValue;
        } catch (e) {
          console.error('[AIReader Prefs] Error getting pref:', key, e);
          return defaultValue;
        }
      },

      setPref: function(key, value) {
        try {
          Zotero.Prefs.set(this.PREF_PREFIX + key, value, true);
        } catch (e) {
          console.error('[AIReader Prefs] Error setting pref:', key, e);
        }
      },

      $: function(id) {
        return document.getElementById(id);
      },

      loadSettings: function() {
        console.log('[AIReader Prefs] Loading settings...');

        // API settings
        this.$('aireader-apiKey').value = this.getPref('apiKey', '');
        this.$('aireader-apiEndpoint').value = this.getPref('apiEndpoint', 'https://api.openai.com/v1');

        const model = this.getPref('model', 'gpt-3.5-turbo');
        this.$('aireader-model').value = model;
        this.$('aireader-customModel').value = this.getPref('customModel', '');
        this.updateCustomModelVisibility(model);

        const temp = this.getPref('temperature', 0.7);
        this.$('aireader-temperature').value = temp;
        this.$('aireader-temperature-value').textContent = temp.toFixed(1);

        // Feature toggles
        this.$('aireader-enableTranslation').checked = this.getPref('enableTranslation', true);
        this.$('aireader-enableSummary').checked = this.getPref('enableSummary', true);
        this.$('aireader-enableQA').checked = this.getPref('enableQA', true);
        this.$('aireader-enableStreaming').checked = this.getPref('enableStreaming', true);
        this.$('aireader-autoSaveHistory').checked = this.getPref('autoSaveHistory', false);
        this.$('aireader-defaultLanguage').value = this.getPref('defaultLanguage', 'zh-CN');

        // Advanced settings
        this.$('aireader-maxTokens').value = this.getPref('maxTokens', 2000);
        this.$('aireader-timeout').value = this.getPref('timeout', 30);
        this.$('aireader-maxHistory').value = this.getPref('maxHistory', 10);
        this.$('aireader-debugMode').checked = this.getPref('debugMode', false);

        console.log('[AIReader Prefs] Settings loaded');
      },

      saveSettings: function() {
        console.log('[AIReader Prefs] Saving settings...');

        // API settings
        this.setPref('apiKey', this.$('aireader-apiKey').value);
        this.setPref('apiEndpoint', this.$('aireader-apiEndpoint').value);

        const model = this.$('aireader-model').value;
        this.setPref('model', model);
        if (model === 'custom') {
          this.setPref('customModel', this.$('aireader-customModel').value);
        }

        this.setPref('temperature', parseFloat(this.$('aireader-temperature').value));

        // Feature toggles
        this.setPref('enableTranslation', this.$('aireader-enableTranslation').checked);
        this.setPref('enableSummary', this.$('aireader-enableSummary').checked);
        this.setPref('enableQA', this.$('aireader-enableQA').checked);
        this.setPref('enableStreaming', this.$('aireader-enableStreaming').checked);
        this.setPref('autoSaveHistory', this.$('aireader-autoSaveHistory').checked);
        this.setPref('defaultLanguage', this.$('aireader-defaultLanguage').value);

        // Advanced settings
        this.setPref('maxTokens', parseInt(this.$('aireader-maxTokens').value, 10));
        this.setPref('timeout', parseInt(this.$('aireader-timeout').value, 10));
        this.setPref('maxHistory', parseInt(this.$('aireader-maxHistory').value, 10));
        this.setPref('debugMode', this.$('aireader-debugMode').checked);

        console.log('[AIReader Prefs] Settings saved');
      },

      updateCustomModelVisibility: function(model) {
        const row = this.$('aireader-customModel-row');
        if (model === 'custom') {
          row.classList.remove('aireader-hidden');
        } else {
          row.classList.add('aireader-hidden');
        }
      },

      testConnection: async function() {
        const resultLabel = this.$('aireader-testResult');
        const testBtn = this.$('aireader-testConnection');

        const apiKey = this.$('aireader-apiKey').value;
        const apiEndpoint = this.$('aireader-apiEndpoint').value;
        let model = this.$('aireader-model').value;

        if (model === 'custom') {
          model = this.$('aireader-customModel').value;
        }

        if (!apiKey || !apiEndpoint) {
          resultLabel.textContent = '请先填写 API Key 和端点';
          resultLabel.className = 'aireader-result error';
          return;
        }

        testBtn.disabled = true;
        testBtn.textContent = '测试中...';
        resultLabel.textContent = '';

        try {
          const response = await fetch(apiEndpoint + '/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify({
              model: model,
              messages: [{ role: 'user', content: 'Hi' }],
              max_tokens: 5
            })
          });

          if (response.ok) {
            resultLabel.textContent = '✓ 连接成功';
            resultLabel.className = 'aireader-result success';
          } else {
            const error = await response.json().catch(() => ({}));
            resultLabel.textContent = '✗ ' + (error.error?.message || '连接失败: ' + response.status);
            resultLabel.className = 'aireader-result error';
          }
        } catch (e) {
          resultLabel.textContent = '✗ 网络错误: ' + e.message;
          resultLabel.className = 'aireader-result error';
        } finally {
          testBtn.disabled = false;
          testBtn.textContent = '测试连接';
        }
      },

      resetToDefaults: function() {
        if (!confirm('确定要重置所有设置为默认值吗？')) {
          return;
        }

        this.$('aireader-apiKey').value = '';
        this.$('aireader-apiEndpoint').value = 'https://api.openai.com/v1';
        this.$('aireader-model').value = 'gpt-3.5-turbo';
        this.$('aireader-customModel').value = '';
        this.updateCustomModelVisibility('gpt-3.5-turbo');
        this.$('aireader-temperature').value = 0.7;
        this.$('aireader-temperature-value').textContent = '0.7';

        this.$('aireader-enableTranslation').checked = true;
        this.$('aireader-enableSummary').checked = true;
        this.$('aireader-enableQA').checked = true;
        this.$('aireader-enableStreaming').checked = true;
        this.$('aireader-autoSaveHistory').checked = false;
        this.$('aireader-defaultLanguage').value = 'zh-CN';

        this.$('aireader-maxTokens').value = 2000;
        this.$('aireader-timeout').value = 30;
        this.$('aireader-maxHistory').value = 10;
        this.$('aireader-debugMode').checked = false;

        this.saveSettings();
        alert('设置已重置为默认值');
      },

      initEventListeners: function() {
        var self = this;

        // Temperature slider
        this.$('aireader-temperature').addEventListener('input', function() {
          self.$('aireader-temperature-value').textContent = parseFloat(this.value).toFixed(1);
          self.saveSettings();
        });

        // Model selection
        this.$('aireader-model').addEventListener('change', function() {
          self.updateCustomModelVisibility(this.value);
          self.saveSettings();
        });

        // All input changes trigger save
        var inputs = [
          'aireader-apiKey', 'aireader-apiEndpoint', 'aireader-customModel',
          'aireader-maxTokens', 'aireader-timeout', 'aireader-maxHistory'
        ];
        inputs.forEach(function(id) {
          self.$(id).addEventListener('change', function() { self.saveSettings(); });
        });

        // Checkboxes
        var checkboxes = [
          'aireader-enableTranslation', 'aireader-enableSummary', 'aireader-enableQA',
          'aireader-enableStreaming', 'aireader-autoSaveHistory', 'aireader-debugMode'
        ];
        checkboxes.forEach(function(id) {
          self.$(id).addEventListener('change', function() { self.saveSettings(); });
        });

        // Select menus
        this.$('aireader-defaultLanguage').addEventListener('change', function() { self.saveSettings(); });

        // Test connection
        this.$('aireader-testConnection').addEventListener('click', function() { self.testConnection(); });

        // Reset defaults
        this.$('aireader-resetDefaults').addEventListener('click', function() { self.resetToDefaults(); });
      }
    };
  ]]></script>

</div>
